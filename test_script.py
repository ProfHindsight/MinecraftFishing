import pyaudio
import sys
import numpy as np
import sounddevice as sd
from scipy import signal
import scipy.io.wavfile as scipyread
import time
import matplotlib.pyplot as plt



# Test Entire Waveform
b = scipyread.read('fish.wav')[1],
# b = np.array(signal.decimate(b, 2, zero_phase=True, ftype='iir'), dtype=np.int16)
bz = np.pad(b, (0,2**24-b.size), mode='constant', constant_values=0)
bft = np.fft.rfft(bz)
nbft = bft / np.linalg.norm(bft)
cbft = np.conj(nbft)

a = scipyread.read('sample_data.wav')[1],
ap = np.pad(a, (0, 2**24-a.size), mode='constant', constant_values=0)
aft = np.fft.rfft(ap)
naft = aft / np.linalg.norm(aft)
c = np.fft.irfft(naft*cbft)

plt.plot(max(abs(c)))
plt.title('Entire waveform')
plt.xlabel('time')
plt.ylabel('confidence')
plt.show()


# Split out waveform
npts = 8192 * 4
trim_a = a[0:a.size - (a.size % npts)]
num_ranges = int(trim_a.size/npts)
split_a = np.split(trim_a, num_ranges)

smpl = np.zeros((num_ranges, 2*npts))
smpl[0,npts:] = split_a[0]

for i in range(0, num_ranges-1):
	smpl[i,:npts] = split_a[i]
	smpl[i,npts:] = split_a[i+1]

smpl[num_ranges-1,:npts] = split_a[num_ranges-1]




b = scipyread.read('fish.wav')[1]
# b = np.array(signal.decimate(b, 2, zero_phase=True, ftype='iir'), dtype=np.int16)
bz = np.pad(b, (0,2**17-b.size), mode='constant', constant_values=0)
bft = np.fft.rfft(bz)
nbft = bft / np.linalg.norm(bft)
cbft = np.conj(nbft)
start_time = time.time()

c = []

for i in range(0, num_ranges):
	a = smpl[i,:]
	ap = np.pad(a, (0, 2**17-a.size), mode='constant', constant_values=0)
	aft = np.fft.rfft(ap)
	naft = aft / np.linalg.norm(aft)
	c.append(max(abs(np.fft.irfft(naft*cbft))))


plt.plot(c)
plt.title('What it should be')
plt.xlabel('time (s)')
plt.ylabel('confidence')
plt.show()


# Log recorded results
log_data = np.array([[0.9984683990478516,3.486878778140269],
[1.7535414695739746,2.477170306858861],
[2.4804539680480957,2.7069122324509363],
[3.2400121688842773,2.9287803592105557],
[4.015562295913696,2.8464885696727538],
[4.719186067581177,9.97189135607495],
[5.469761371612549,8.954988409924562],
[6.198662042617798,15.658717759432449],
[6.941523551940918,12.635222914201352],
[7.701797723770142,14.475860722443688],
[8.43783974647522,14.097675654197499],
[9.178689002990723,5.554718357879263],
[9.912233352661133,14.473052593412202],
[10.67110800743103,14.657504117570893],
[11.43393087387085,14.051687765101336],
[12.14131474494934,5.258843455031856],
[12.890582799911499,5.3149548949868395],
[13.630838394165039,3.133132771095505],
[14.381538391113281,3.33426436973987],
[15.129354000091553,10.929470942121666],
[15.86138105392456,11.102909524519804],
[16.601072549819946,5.375645346096475],
[17.338655948638916,4.231702647422164],
[18.0892231464386,3.241524394639227],
[18.83921766281128,3.2813704770485677],
[19.569368839263916,2.868749817232515],
[20.31991958618164,25.71067350695578],
[21.070395469665527,24.24737001353294],
[21.800480365753174,6.557993101838626],
[22.55006504058838,8.70696549631307],
[23.301485776901245,10.93181862301058],
[24.030560731887817,12.918141913615141],
[24.779326915740967,6.405231091824722],
[25.527193307876587,6.97193724421849],
[26.25815486907959,3.268679324140145],
[27.019940614700317,12.96958011477144],
[27.761847972869873,16.01648396320975],
[28.496920824050903,9.91267602598528],
[29.229114770889282,9.385866625053517],
[29.988878965377808,16.58813057479079],
[30.719997882843018,30.188902453459388],
[31.46922516822815,21.773169332447665],
[32.20802164077759,4.234306591597748],
[32.95383548736572,3.123303330757907],
[33.69588899612427,3.3799264004909855],
[34.4882972240448,3.529682561210594],
[35.17910075187683,3.0557386554979105],
[35.92078351974487,2.9875575389413447],
[36.66127371788025,3.200627258355549],
[37.41891431808472,10.982709175488688],
[38.152423620224,10.987372982621041],
[38.89017081260681,15.31703008121269],
[39.65016174316406,15.819315674832602],
[40.38090753555298,8.1758880696179],
[41.12156891822815,8.57520768337408],
[41.8679940700531,3.2219587092457522],
[42.61061882972717,21.64713622822274],
[43.35299205780029,20.905120043759652],
[44.10159993171692,4.541416350210843],
[44.851773262023926,2.8961014213688117],
[45.58045792579651,2.558120951447176],
[46.32167649269104,3.135275824046923],
[47.07119011878967,3.5510759992385443],
[47.85362505912781,4.838657637257661],
[48.55845093727112,11.985911464387433],
[49.300848722457886,12.899357181321667],
[50.0451934337616,10.446108666280196],
[50.77956748008728,10.22214192043626],
[51.520355463027954,8.547430522568277],
[52.27717638015747,8.978446538270203],
[53.02076196670532,3.2433848411044215],
[53.74897217750549,3.1234608540689948],
[54.4970588684082,4.145462919522085],
[55.262043952941895,9.61144703879697],
[56.01103448867798,9.965440355689912],
[56.73081350326538,4.588488232173028],
[57.47003960609436,4.293403604398974],
[58.22037386894226,11.800456869221865],
[58.95922613143921,11.434745380598788],
[59.71125650405884,4.789783583432499],
[60.44046664237976,10.0458077408423],
[61.17800974845886,19.909986244792428],
[61.98063588142395,20.255706864746926],
[62.66911768913269,6.975528555525747],
[63.40941834449768,8.442170200834243],
[64.15913438796997,7.497507477814295],
[64.91012597084045,4.846918387086502],
[65.64084577560425,4.997472354127091],
[66.39464354515076,4.768613988813809],
[67.13221263885498,3.9606556062162803],
[67.87988090515137,4.414987807895246],
[68.61421132087708,22.014157081957446],
[69.37783432006836,21.877189224853026],
[70.09903526306152,3.3478339063828004],
[70.8376739025116,4.0413747316751065],
[71.59082007408142,8.957073549865578],
[72.33887147903442,7.666599893827152],
[73.08089709281921,4.718252735422585],
[73.82876634597778,8.798844528603542],
[74.57072973251343,8.888112816842446],
[75.30123043060303,4.791231943513938],
[76.05023002624512,9.272897382224581],
[76.80191206932068,9.633847638721926],
[77.5295021533966,3.0829986829724176],
[78.27998399734497,6.288702264991737],
[79.01939582824707,6.391507749842059],
[79.76091837882996,11.380808327296254],
[80.50292682647705,11.996781706516664],
[81.2546157836914,58.81832301242207],
[83.4096143245697,3.4485949829837663],
[84.15737891197205,2.528126193953796],
[84.90010142326355,2.5689603988918788],
[85.64963459968567,9.939462968491299],
[86.38120484352112,24.424050433023456],
[87.12057399749756,25.418370591327037],
[87.8677122592926,20.732298929748996],
[88.60930728912354,29.466589435730743],
[89.35924744606018,6.736735296134177],
[90.11062622070312,6.064814223160367],
[90.83875155448914,5.291910255959623],
[91.58917212486267,3.9439702286921663],
[92.33038568496704,4.9485108240505316],
[93.08488178253174,12.283799993577604],
[93.81013894081116,12.62034489211372],
[94.55768036842346,3.687679391746431],
[95.30914688110352,3.2234412428519206],
[96.05217003822327,2.8309659161453617],
[96.78380370140076,4.564631050791003],
[97.52728247642517,11.029141513964774],
[98.27084636688232,11.94863640771478],
[99.04426145553589,2.605284127288238],
[99.75974416732788,2.9742104827108586],
[100.50043106079102,3.0616707705947883],
[101.25127673149109,2.7761499389830138],
[101.98133516311646,14.608255403234805],
[102.73000645637512,14.12658734992165],
[103.47070932388306,5.737497861240015],
[104.22022080421448,3.5022897797075054],
[104.96037936210632,7.9532487541315895],
[105.69980716705322,13.203643470266512],
[106.44781279563904,14.094915387922807],
[107.19934868812561,3.4912083069733053],
[107.92962503433228,12.126493461913178],
[108.68277645111084,16.937438448642602],
[109.41183829307556,70.26045653669792],
[111.54938697814941,3.2396532824097277],
[112.29843997955322,2.5397509640669926],
[113.06482648849487,3.210442763872927],
[113.78730058670044,9.943736077449415],
[114.5189278125763,24.436481160831423],
[115.27125644683838,25.43682107654042],
[116.00930523872375,20.492080228065255],
[116.75999879837036,28.108857780505264],
[117.49985837936401,6.315280829660368],
[118.29523658752441,5.610954056003428],
[118.9898841381073,4.944475021767057],
[119.72004580497742,4.281850567555548],
[120.50847172737122,4.432786351227642],])

plt.plot(log_data[:,0], log_data[:,1])
plt.title('Recorded output')
plt.xlabel('time (s)')
plt.ylabel('confidence')
plt.show()
